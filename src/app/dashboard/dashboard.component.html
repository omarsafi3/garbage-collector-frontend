<div class="modern-dashboard">

    <!-- Top Bar -->
    <div class="control-bar">
        <div class="control-bar-left">
            <h1>üöõ Fleet Operations</h1>
            <div class="live-badge">
                <span class="pulse-dot"></span>
                Live Tracking
            </div>
        </div>

        <div class="control-bar-stats">
            <div class="stat-pill critical">
                <div class="stat-number">{{ departmentStats?.criticalBins || 0 }}</div>
                <div class="stat-label">Critical Bins</div>
            </div>

            <div class="stat-pill active">
                <div class="stat-number">{{ activeTrucks.size }}</div>
                <div class="stat-label">Active Trucks</div>
            </div>

            <div class="stat-pill"
                style="background: linear-gradient(135deg, #10b981, #059669); color: white; box-shadow: 0 8px 30px rgba(16, 185, 129, 0.3); border: 1px solid rgba(52, 211, 153, 0.3);">
                <div class="stat-number">{{ departmentStats?.averageFillLevel || 0 }}%</div>
                <div class="stat-label">Avg Fill</div>
            </div>
        </div>
    </div>

    <!-- Main Content - 3 Column Layout -->
    <div class="main-content">

        <!-- LEFT: Active Routes -->
        <div class="active-routes-section" *ngIf="activeTrucks.size > 0">
            <div class="section-header">
                <div class="section-title-group">
                    <h2>üö¶ Active Routes</h2>
                    <span class="route-count">{{ activeTrucks.size }} running</span>
                </div>
            </div>

            <div class="active-routes-grid">
                <div class="active-route-card" *ngFor="let truck of getActiveTrucksArray(); let i = index">
                    <div class="route-card-header">
                        <span class="route-vehicle">
                            <span [style.color]="getRouteColor(i)" style="font-size: 20px;">‚óè</span>
                            üöõ {{ getVehicleName(truck.vehicleId) }}
                        </span>
                        <span class="route-progress-badge">{{ truck.progress?.toFixed(0) || 0 }}%</span>
                    </div>
                    <div class="route-progress-bar">
                        <div class="route-progress-fill" [style.width.%]="truck.progress || 0"
                            [style.background]="getProgressGradient(truck.progress || 0)">
                        </div>
                    </div>

                    <!-- ‚úÖ Show assigned employees in active truck -->
                    <div class="truck-crew" *ngIf="getAssignedEmployees(truck.vehicleId)[0]">
                        <div class="crew-label">üë∑ Crew:</div>
                        <div class="crew-members">
                            <span class="crew-badge">{{ getEmployeeName(getAssignedEmployees(truck.vehicleId)[0]) }}</span>
                            <span class="crew-badge">{{ getEmployeeName(getAssignedEmployees(truck.vehicleId)[1]) }}</span>
                        </div>
                    </div>

                    <div class="route-details" *ngIf="getVehicleProgress(truck.vehicleId)">
                        <span class="route-detail-text">{{ getVehicleProgress(truck.vehicleId) }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- MIDDLE: Vehicles Section -->
        <div class="vehicles-section">
            <div class="section-header">
                <h2>üöó Active Vehicles</h2>
                <div class="header-actions">
                    <span class="vehicle-count">{{ selectedDeptVehicles.length }} trucks</span>
                    
                    <!-- ‚úÖ Dispatch All Button (improved with employee check) -->
                    <button class="action-btn success" (click)="dispatchAllAvailableWithEmployees()"
                        [disabled]="getAvailableVehiclesOnly().length === 0">
                        üöÄ Dispatch All ({{ getAvailableVehiclesOnly().length }})
                    </button>

                    <!-- ‚úÖ NEW: Manual Route Generation -->
                    <button class="action-btn warning" (click)="manualGenerateRoutes()">
                        üîÑ Generate Routes
                    </button>

                    <!-- ‚úÖ NEW: Check Critical Bins -->
                    <button class="action-btn danger" (click)="checkCriticalBins()">
                        üö® Check Critical
                    </button>
                    
                    <!-- ‚úÖ Map Button -->
                    <button class="action-btn map" (click)="openMapModal()">
                        üó∫Ô∏è View Map
                    </button>
                </div>
            </div>

            <div class="vehicles-horizontal-grid">
                <div class="vehicle-card-horizontal" *ngFor="let vehicle of selectedDeptVehicles"
                    [class.vehicle-active]="activeTrucks.has(vehicle.id)">

                    <div class="vehicle-card-top">
                        <div class="vehicle-icon-large">üöõ</div>
                        <div class="vehicle-info-compact">
                            <h3>{{ vehicle.reference }}</h3>
                            <div class="plate-badge">{{ vehicle.plate }}</div>
                        </div>
                        <span class="status-dot" [ngClass]="getVehicleStatusClass(vehicle.id, vehicle.available)">
                            {{ getVehicleStatusText(vehicle.id, vehicle.available) }}
                        </span>
                    </div>

                    <div class="fill-section">
                        <div class="fill-header">
                            <span>Truck Fill</span>
                            <strong>{{ vehicle.fillLevel | number:'1.0-0' }}%</strong>
                        </div>
                        <div class="fill-bar-container">
                            <div class="fill-bar-track"></div>
                            <div class="fill-bar-progress" [style.width.%]="vehicle.fillLevel"
                                [style.background]="getFillGradient(vehicle.fillLevel)">
                            </div>
                        </div>
                    </div>

                    <div class="progress-info"
                        *ngIf="getVehicleProgress(vehicle.id) || unloadingVehicles.has(vehicle.id)">
                        <span class="progress-text" *ngIf="!unloadingVehicles.has(vehicle.id)">
                            {{ getVehicleProgress(vehicle.id) }}
                        </span>
                        <span class="progress-text unloading" *ngIf="unloadingVehicles.has(vehicle.id)">
                            üè≠ Unloading... {{ vehicle.fillLevel | number:'1.0-0' }}%
                        </span>
                    </div>

                    <div class="card-actions" *ngIf="!activeTrucks.has(vehicle.id) && vehicle.available">
                        <!-- Employee Assignment -->
                        <div class="employee-assignment-box">
                            <div class="assignment-header">üë∑ Assign 2 Employees</div>

                            <select [value]="getVehicleEmployees(vehicle.id)[0]"
                                (change)="setVehicleEmployee(vehicle.id, 0, $any($event.target).value)"
                                class="employee-selector">
                                <option value="">üë§ Select Employee 1...</option>
                                <option *ngFor="let emp of availableEmployees" [value]="emp.id">
                                    {{ emp.firstName }} {{ emp.lastName }}
                                </option>
                            </select>

                            <select [value]="getVehicleEmployees(vehicle.id)[1]"
                                (change)="setVehicleEmployee(vehicle.id, 1, $any($event.target).value)"
                                class="employee-selector">
                                <option value="">üë§ Select Employee 2...</option>
                                <option *ngFor="let emp of availableEmployees" [value]="emp.id">
                                    {{ emp.firstName }} {{ emp.lastName }}
                                </option>
                            </select>

                            <div class="assigned-badges"
                                *ngIf="getAssignedEmployees(vehicle.id)[0] && getAssignedEmployees(vehicle.id)[1]">
                                <span class="employee-badge">‚úÖ {{ getEmployeeName(getAssignedEmployees(vehicle.id)[0]) }}</span>
                                <span class="employee-badge">‚úÖ {{ getEmployeeName(getAssignedEmployees(vehicle.id)[1]) }}</span>
                            </div>

                            <div class="warning"
                                *ngIf="!getAssignedEmployees(vehicle.id)[0] || !getAssignedEmployees(vehicle.id)[1]">
                                ‚ö†Ô∏è Both employees required
                            </div>
                        </div>

                        <!-- Route selector -->
                        <select [(ngModel)]="vehicle['selectedRouteId']" class="route-selector"
                            [disabled]="availableRoutes.length === 0">
                            <option value="">üìç Select a route...</option>
                            <option *ngFor="let route of availableRoutes; let i = index" [value]="route.routeId">
                                {{ getRouteColorEmoji(i) }} Route {{ i + 1 }} ({{ route.binCount }} bins)
                            </option>
                        </select>

                        <button class="btn-dispatch"
                            (click)="dispatchVehicleWithRoute(vehicle.id, vehicle['selectedRouteId'] || '')"
                            [disabled]="!canDispatch(vehicle.id, vehicle['selectedRouteId'])">
                            üöÄ Dispatch Vehicle
                        </button>

                        <div class="validation-error" *ngIf="!canDispatch(vehicle.id, vehicle['selectedRouteId'])">
                            ‚ö†Ô∏è Please assign 2 employees and select a route
                        </div>
                    </div>

                    <div class="card-actions" *ngIf="activeTrucks.has(vehicle.id)">
                        <div class="in-route-badge">üîÑ In Route</div>
                    </div>

                    <div class="card-actions" *ngIf="!vehicle.available && !activeTrucks.has(vehicle.id)">
                        <div class="busy-badge">‚è∏Ô∏è Busy</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: Employee Pool -->
        <div class="employee-pool-section">
            <div class="section-header">
                <h2>üë∑ Employee Pool</h2>
                <span class="employee-pool-count">{{ getTrulyAvailableEmployees().length }} available</span>
            </div>

            <div class="employee-list">
                <div class="employee-status-group">
                    <h3 class="group-title">‚úÖ Available</h3>
                    <div class="employee-card available" *ngFor="let emp of getTrulyAvailableEmployees()">
                        <div class="employee-avatar">üë§</div>
                        <div class="employee-info">
                            <div class="employee-name">{{ emp.firstName }} {{ emp.lastName }}</div>
                            <div class="employee-status-text">Ready for dispatch</div>
                        </div>
                    </div>
                    <div class="empty-state" *ngIf="getTrulyAvailableEmployees().length === 0">
                        All employees are currently assigned
                    </div>
                </div>

                <div class="employee-status-group" *ngIf="getEmployeesInTrucks().length > 0">
                    <h3 class="group-title">üöõ In Active Trucks</h3>
                    <div class="employee-card in-truck" *ngFor="let emp of getEmployeesInTrucks()">
                        <div class="employee-avatar">üöõ</div>
                        <div class="employee-info">
                            <div class="employee-name">{{ emp.firstName }} {{ emp.lastName }}</div>
                            <div class="employee-status-text">On route</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ‚úÖ Analytics Section -->
    <div class="analytics-section" *ngIf="selectedDepartment && analyticsData">
        <h3 class="section-title">üìä Analytics Overview (Last 30 Days)</h3>

        <div class="analytics-grid">
            <div class="analytics-card co2-card">
                <div class="card-icon">üåç</div>
                <div class="card-content">
                    <h4>CO2 Emissions</h4>
                    <div class="metric-value">{{ analyticsData.totalCO2EmissionsKg | number:'1.0-0' }} kg</div>
                    <div class="metric-detail">üå≥ {{ analyticsData.treesNeededToOffset | number:'1.0-0' }} trees</div>
                    <div class="metric-small">Avg: {{ analyticsData.avgCO2PerRoute | number:'1.0-0' }} kg/route</div>
                </div>
            </div>

            <div class="analytics-card cost-card">
                <div class="card-icon">üí∞</div>
                <div class="card-content">
                    <h4>Total Cost</h4>
                    <div class="metric-value">‚Ç¨{{ analyticsData.totalCostEuros | number:'1.0-2' }}</div>
                    <div class="metric-detail">‚õΩ {{ analyticsData.totalFuelLiters | number:'1.0-0' }} L fuel</div>
                    <div class="metric-small">Avg: ‚Ç¨{{ analyticsData.avgCostPerRoute | number:'1.0-2' }}/route</div>
                </div>
            </div>

            <div class="analytics-card efficiency-card">
                <div class="card-icon">‚ö°</div>
                <div class="card-content">
                    <h4>Efficiency</h4>
                    <div class="metric-value">{{ analyticsData.totalBinsCollected }} bins</div>
                    <div class="metric-detail">üìç {{ analyticsData.totalDistanceKm | number:'1.0-2' }} km</div>
                    <div class="metric-small">{{ analyticsData.totalRoutes }} routes</div>
                </div>
            </div>

            <div class="analytics-card routes-card">
                <div class="card-icon">üöõ</div>
                <div class="card-content">
                    <h4>Recent Routes</h4>
                    <div class="recent-routes-list" *ngIf="recentRoutes.length > 0">
                        <div class="route-item" *ngFor="let route of recentRoutes">
                            <span class="route-vehicle">{{ route.vehicleReference }}</span>
                            <span class="route-bins">{{ route.binsCollected }} bins</span>
                            <span class="route-distance">{{ route.totalDistanceKm | number:'1.0-0' }} km</span>
                        </div>
                    </div>
                    <div class="metric-small" *ngIf="recentRoutes.length === 0">No routes yet</div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- ‚úÖ MAP MODAL POPUP - Map always loaded, modal shows/hides -->
<div class="map-modal-overlay" [class.hidden]="!showMapModal" (click)="closeMapModal()">
    <div class="map-modal-container" (click)="$event.stopPropagation()">
        <div class="map-modal-header">
            <h2>üó∫Ô∏è Live Map</h2>
            <button class="modal-close-btn" (click)="closeMapModal()">‚úï</button>
        </div>
        <div class="map-modal-body">
            <!-- ‚úÖ Map always in DOM, just hidden when modal is closed -->
            <app-map></app-map>
        </div>
    </div>
</div>
